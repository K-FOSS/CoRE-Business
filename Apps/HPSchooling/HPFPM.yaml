apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  name: core-business-hpschool-fpm-helm
  namespace: argocd
spec:
  generators:
    - list:
        elements:
          - cluster: k0s-cntrl
            url: https://k0s-dc1-kubernetes-default.service.dc1.kjdev:6443
  template:
    metadata:
      name: '{{cluster}}-business-hpschool-fpm-helm'
    spec:
      project: core
      syncPolicy:
        automated:
          selfHeal: true
          prune: true
        syncOptions:
          - CreateNamespace=true
      source:
        repoURL: https://k8s-at-home.com/charts/
        chart: nginx-php
        path: nginx-php
        targetRevision: 1.0.0
        helm:
          releaseName: hpschool-fpm
          values: |
            # -- environment variables. See more environment variables in the [nginx-php documentation](https://nginx-php.org/docs).
            # @default -- See below
            env:
              # -- Set the container timezone
              TZ: UTC

            # -- Configures service settings for the chart.
            # @default -- See values.yaml
            service:
              main:
                ports:
                  http:
                    port: 8080

            # -- Overwrites default config files for nginx or php/php-fpm if enabled.
            # @default -- See https://github.com/TrafeX/docker-php-nginx/tree/master/config for defaults
            config:
              nginx-server.conf: {}

              php-settings.ini: {}

              php-fpm-server.conf: {}

            ingress:
              # -- Enable and configure ingress settings for the chart under this key.
              # @default -- See values.yaml
              main:
                enabled: true
                ingressClassName: traefik-core
                labels:
                  wan-mode: 'public'
                  lan-mode: 'private'
                annotations:
                  cert-manager.io/cluster-issuer: kjdev-cluster
                  external-dns.alpha.kubernetes.io/target: k0s-dc1.resolvemy.host.
                  traefik.ingress.kubernetes.io/router.entrypoints: websecure
                  traefik.ingress.kubernetes.io/router.tls: 'true'
                hosts:
                  - host: hpphp.writemy.codes
                    paths:
                      - path: /
                        pathType: Prefix
                tls:
                  - hosts:
                      - '*.writemy.codes'
                    secretName: writemycodes-default-certificates

            # -- Configure persistence settings for the chart under this key.
            # @default -- See values.yaml
            persistence:
              data:
                enabled: true
                mountPath: /var/www/html
                existingClaim: hpschool-phpcore

      destination:
        server: '{{url}}'
        namespace: core-prod
