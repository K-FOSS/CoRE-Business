---
{{- include "bjw-s.common.loader.init" . }}

{{- define "app-template.hardcodedValues" -}}
# Set the nameOverride based on the release name if no override has been set
{{ if not .Values.global.nameOverride }}
global:
  nameOverride: "{{ .Release.Name }}"
{{ end }}

controllers:
  {{- range $desktopIndex, $desktopServer := $.Values.desktops }}
  desktop-{{ $desktopServer.name }}:
    # For Deployments, valid values are Recreate (default) and RollingUpdate.
    # For StatefulSets, valid values are OnDelete and RollingUpdate (default).
    # DaemonSets/CronJobs ignore this.
    strategy: RollingUpdate

    pod:
      {{- with $desktopServer.nodeSelector }}
      nodeSelector:
        {{ toYaml . | nindent 8 }}
      {{- end }}

      runtimeClassName: '{{ $desktopServer.runtimeClassName }}'

    containers:
      {{ $desktopServer.name }}:
        image:
          repository: {{ $desktopServer.image }}
          tag: {{ default "latest" $desktopServer.tag }}
          pullPolicy: Always

        {{- with $desktopServer.env }}
        env:
          {{ toYaml . | nindent 10 }}
        {{- end }}

        ports:
          - name: http
            containerPort: 8080

  {{- end }}

persistence:
  {{- range $desktopIndex, $desktopServer := $.Values.desktops }}
  {{- if eq (default false $desktopServer.volume.enabled) true }}
  desktop-{{ $desktopServer.name }}:
    enabled: true
    type: persistentVolumeClaim

    size: {{ default '10Gi' $desktopServer.volume.size }}

    accessMode: ReadWriteOnce

    advancedMounts:
      desktop-{{ $desktopServer.name }}:
        {{ $desktopServer.name }}:
          - path: {{ $desktopServer.volume.mount }}
  {{- end }}
  {{- end }}

{{- end -}}
{{- $_ := mergeOverwrite .Values (include "app-template.hardcodedValues" . | fromYaml) -}}

{{/* Render the templates */}}
{{ include "bjw-s.common.loader.generate" . }}